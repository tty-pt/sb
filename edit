#!/bin/sh

im $OWNER || Forbidden

if test $REQUEST_METHOD = POST; then
	c=0
	while test $c -lt $HTTP_PARAM_count; do
		eval "csong=\${HTTP_PARAM_song_$c}"
		eval "ct=\${HTTP_PARAM_t_$c}"
		csong="`urldecode "$csong"`"
		echo $csong:$ct
		c=`math $c + 1`
	done > $ITEM_PATH/data.txt

	SeeOther .
fi

chords_path="$DOCUMENT_ROOT/items/chords/items"

proc() {
	counter=0
	while IFS=: read song t format; do
		path="$DOCUMENT_ROOT/items/chords/items/$song"
		echo "<div class='f h'>"
		echo "<select name='song_$counter'>"
		echo FORMAT $format >&2
		if test -z "$format"; then
			qhash -l $chords_path/index.db
		else
			qhash -m1 -q $chords_path/index.db -rg$format $chords_path/assoc.db
		fi | while read id title; do
			attr="`test "$song" != "$id" || echo selected`"
			echo "<option $attr value='$id'>$title</option>"
		done
		echo "</select>"
		echo "<input name='t_$counter' type='number' step='1' value='$t'></input>"
		RB üëÅ "/chords/$song?t=$t"
		echo "</div>"
		counter="`math $counter + 1`"
	done
	echo "<input type='hidden' name='count' value='$counter'></input>"
}

echo "<form action='.' method='POST' class='v f fic'>"
cat $ITEM_PATH/data.txt | proc
echo "<button class='rs ps'>`_ Submit`</button>"
echo "</form>"
